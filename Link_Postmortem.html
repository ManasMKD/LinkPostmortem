<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Postmortem</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">

    <!-- ============================================================ -->
    <!-- AD SPACE: GLOBAL SCRIPTS                                     -->
    <!-- Paste your Google AdSense (or other network) script tag here -->
    <!-- ============================================================ -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        zinc: { 950: '#09090b' } // Deep black/zinc
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000000; color: #d4d4d8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #18181b; }
        textarea::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        /* Scrollbar for buttons container */
        .btn-scroll::-webkit-scrollbar { width: 4px; }
        .btn-scroll::-webkit-scrollbar-track { background: transparent; }
        .btn-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }

        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="selection:bg-rose-900 selection:text-white min-h-screen flex flex-col">

    <!-- NAVIGATION -->
    <nav class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-zinc-900">
        <div class="container mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-zinc-900 border border-zinc-800 rounded-lg flex items-center justify-center text-rose-600 font-bold text-xl shadow-[0_0_15px_rgba(225,29,72,0.3)]">
                    <i data-lucide="skull" class="w-5 h-5"></i>
                </div>
                <span class="text-xl font-bold text-white tracking-wider">
                    Link <span class="text-rose-600">Postmortem</span>
                </span>
            </div>

            <!-- Desktop Nav -->
            <div class="hidden md:flex items-center gap-1 bg-zinc-900/50 p-1 rounded-full border border-zinc-800">
                <button onclick="switchTab('downloader')" id="btn-nav-downloader" class="px-6 py-1.5 rounded-full text-sm font-medium transition-all bg-zinc-800 text-white shadow-lg">Downloader</button>
                <button onclick="switchTab('crypter')" id="btn-nav-crypter" class="px-6 py-1.5 rounded-full text-sm font-medium transition-all text-zinc-500 hover:text-zinc-300">Encrypter</button>
            </div>

            <!-- Mobile Menu Toggle -->
            <button onclick="toggleMenu()" class="md:hidden p-2 text-zinc-400">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-zinc-950 border-b border-zinc-900 p-4 flex flex-col gap-4">
            <button onclick="switchTab('downloader'); toggleMenu()" class="text-left text-zinc-300 font-medium p-2 hover:bg-zinc-900 rounded">Downloader</button>
            <button onclick="switchTab('crypter'); toggleMenu()" class="text-left text-zinc-300 font-medium p-2 hover:bg-zinc-900 rounded">Link Crypter</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="relative pt-12 pb-24 overflow-hidden flex-grow relative">
        
        <!-- Background Gradients -->
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full z-0 pointer-events-none opacity-20">
            <div class="absolute top-20 left-1/4 w-[300px] md:w-[500px] h-[300px] md:h-[500px] bg-rose-900/40 rounded-full mix-blend-screen filter blur-[80px] md:blur-[100px] animate-pulse"></div>
            <div class="absolute bottom-20 right-1/4 w-[300px] md:w-[400px] h-[300px] md:h-[400px] bg-indigo-900/40 rounded-full mix-blend-screen filter blur-[80px] md:blur-[100px]"></div>
        </div>

        <div class="container mx-auto px-4 relative z-10">

            <!-- ============================================================ -->
            <!-- AD SPACE: TOP BANNER                                         -->
            <!-- ============================================================ -->
            <!-- 
            <div class="w-full max-w-4xl mx-auto mb-8 bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 flex justify-center items-center">
                 Place ad code here 
            </div> 
            -->

            <!-- TAB: DOWNLOADER -->
            <div id="tab-downloader" class="tab-content active animate-in">
                <div class="text-center mb-10">
                    <h1 class="text-4xl md:text-6xl font-black tracking-tight mb-4 text-white">
                        Extract <span class="text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-orange-600">Remote</span> Content
                    </h1>
                    <p class="text-zinc-500 max-w-xl mx-auto text-lg">
                        Bypass restrictions and access your files directly via our secure tunnel.
                    </p>
                </div>

                <div class="max-w-3xl mx-auto bg-zinc-900/50 backdrop-blur-md rounded-2xl shadow-2xl border border-zinc-800 p-3 mb-8">
                    <form onsubmit="handleDownload(event)" class="relative flex flex-col md:flex-row gap-2">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-zinc-500">
                                <i data-lucide="link" class="w-5 h-5"></i>
                            </div>
                            <input type="text" id="dl-input" placeholder="Paste source link (Cloud or Direct)..." 
                                class="w-full pl-12 pr-10 py-4 rounded-xl bg-black border border-zinc-800 focus:border-rose-600 focus:ring-1 focus:ring-rose-600 outline-none transition-all text-white placeholder:text-zinc-600">
                            <!-- Clear Button -->
                            <button type="button" onclick="clearInput('dl-input')" class="absolute inset-y-0 right-0 pr-4 flex items-center text-zinc-600 hover:text-zinc-300 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <button type="submit" id="dl-btn"
                            class="bg-rose-600 hover:bg-rose-700 disabled:bg-zinc-700 disabled:text-zinc-500 text-white font-bold py-4 px-8 rounded-xl transition-all flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(225,29,72,0.3)] hover:shadow-[0_0_30px_rgba(225,29,72,0.5)]">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            <span>Extract</span>
                        </button>
                    </form>
                </div>

                <!-- ============================================================ -->
                <!-- AD SPACE: MIDDLE CONTENT                                     -->
                <!-- ============================================================ -->
                <!-- 
                <div class="w-full max-w-3xl mx-auto mb-8 flex justify-center">
                     Place ad code here 
                </div> 
                -->

                <div id="dl-error" class="hidden max-w-3xl mx-auto mb-8 p-4 bg-rose-950/30 text-rose-400 border border-rose-900/50 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    <span id="dl-error-text"></span>
                </div>

                <!-- DIRECT MEDIA RESULT -->
                <div id="media-result" class="hidden max-w-3xl mx-auto mt-8 animate-in">
                    <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-rose-900/20 rounded-full flex items-center justify-center text-rose-500 mb-4 animate-pulse">
                            <i data-lucide="file-video" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Direct Media Detected</h3>
                        <p class="text-zinc-400 mb-6 text-sm max-w-md">
                            The link appears to be a direct media file (MP4, M3U8, MKV, etc.). You can access it directly without the secure tunnel.
                        </p>
                        <div class="flex gap-3">
                            <a id="media-download-btn" href="#" target="_blank" rel="noopener noreferrer" 
                               class="bg-white text-black hover:bg-zinc-200 font-bold py-3 px-8 rounded-full flex items-center gap-2 transition-all shadow-lg hover:scale-105">
                                <i data-lucide="download" class="w-4 h-4"></i> <span id="media-btn-label">Download / Play</span>
                            </a>
                        </div>
                        <div class="mt-6 w-full">
                            <div class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest mb-1">Source URL</div>
                            <div class="text-xs text-zinc-400 font-mono bg-black px-3 py-2 rounded border border-zinc-800 break-all w-full text-center">
                                <span id="media-url-display"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TUNNEL RESULT -->
                <div id="dl-result" class="hidden max-w-5xl mx-auto mt-8 animate-in">
                    <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-4 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <p class="text-sm text-zinc-300">Tunnel established successfully. Loading external content...</p>
                        </div>
                        <a id="dl-external-link" href="#" target="_blank" rel="noopener noreferrer"
                            class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-white px-5 py-2.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors">
                            Open in New Tab <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div class="bg-black rounded-2xl shadow-2xl overflow-hidden border border-zinc-800 relative h-[600px]">
                        <iframe id="dl-iframe" src="" title="Secure Download Server" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                    </div>
                </div>
            </div>

            <!-- TAB: CRYPTER -->
            <div id="tab-crypter" class="tab-content animate-in">
                <div class="text-center mb-10">
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-4 text-white">
                        Link <span class="text-rose-600">Obfuscator</span>
                    </h1>
                    <p class="text-zinc-500 max-w-lg mx-auto">
                        Encrypt multiple links into a single payload. Links can be Time-Locked to expire automatically.
                    </p>
                </div>

                <!-- ============================================================ -->
                <!-- AD SPACE: CRYPTER BANNER                                     -->
                <!-- ============================================================ -->
                <!-- 
                <div class="w-full max-w-4xl mx-auto mb-8 flex justify-center">
                     Place ad code here 
                </div> 
                -->

                <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-6 bg-zinc-900/30 p-2 rounded-2xl border border-zinc-800 backdrop-blur-sm">
                    
                    <!-- Input Section -->
                    <div class="bg-black/50 p-6 rounded-xl border border-zinc-800 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-sm font-bold text-zinc-400 uppercase tracking-wider">Input Payload</label>
                            <div class="flex bg-zinc-900 rounded-lg p-1 border border-zinc-800">
                                <button onclick="setCryptoMode('encrypt')" id="mode-encrypt" class="p-1.5 rounded-md transition-all bg-zinc-700 text-white" title="Encrypt Mode"><i data-lucide="lock" class="w-4 h-4"></i></button>
                                <button onclick="setCryptoMode('decrypt')" id="mode-decrypt" class="p-1.5 rounded-md transition-all text-zinc-600 hover:text-zinc-400" title="Decrypt Mode"><i data-lucide="unlock" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        
                        <div class="relative w-full flex-grow flex flex-col">
                            <textarea id="crypto-input" placeholder="Paste link(s) here..." class="w-full flex-grow bg-zinc-900 border border-zinc-800 rounded-lg p-4 pr-10 text-zinc-300 focus:border-rose-600 focus:ring-1 focus:ring-rose-600 outline-none resize-none font-mono text-sm min-h-[150px]"></textarea>
                            <!-- Input Actions -->
                            <div class="absolute top-2 right-2 flex flex-col gap-1">
                                <button onclick="clearInput('crypto-input')" class="p-1.5 text-zinc-500 hover:text-white bg-zinc-800/50 rounded hover:bg-zinc-800 transition-colors" title="Clear">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                                <button onclick="pasteToInput('crypto-input')" class="p-1.5 text-zinc-500 hover:text-white bg-zinc-800/50 rounded hover:bg-zinc-800 transition-colors" title="Paste">
                                    <i data-lucide="clipboard" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Settings Grid -->
                        <div id="crypto-settings" class="mt-4 grid grid-cols-2 gap-3">
                            <!-- Passcode Field -->
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="key" class="w-3 h-3 text-zinc-500"></i>
                                    <label class="text-xs font-bold text-zinc-500 uppercase tracking-wider">Passcode</label>
                                </div>
                                <input type="text" id="crypto-pass" placeholder="Optional PIN" 
                                    class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:border-rose-600 outline-none transition-colors">
                            </div>
                            
                            <!-- Expiration Field (New) -->
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="clock" class="w-3 h-3 text-zinc-500"></i>
                                    <label class="text-xs font-bold text-zinc-500 uppercase tracking-wider">Lifespan</label>
                                </div>
                                <select id="crypto-expiry" class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 focus:border-rose-600 outline-none transition-colors appearance-none">
                                    <option value="0">Eternal (Never)</option>
                                    <option value="5">5 Minutes</option>
                                    <option value="30">30 Minutes</option>
                                    <option value="60">1 Hour</option>
                                    <option value="1440">24 Hours</option>
                                    <option value="10080">7 Days</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="handleCryptoProcess()" id="crypto-action-btn" class="mt-4 w-full bg-white text-black hover:bg-zinc-200 font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                            <i data-lucide="lock" id="action-icon" class="w-4 h-4"></i>
                            <span id="action-text">Encrypt Payload</span>
                        </button>
                    </div>

                    <!-- Output Section -->
                    <div class="bg-zinc-900/80 p-6 rounded-xl border border-zinc-800 flex flex-col h-full relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-rose-600/10 blur-xl rounded-full"></div>
                        
                        <div class="flex justify-between items-center mb-4 relative z-10">
                            <label class="text-sm font-bold text-zinc-400 uppercase tracking-wider">Result</label>
                            <button id="btn-copy" onclick="copyToClipboard()" class="hidden text-xs flex items-center gap-1 text-rose-500 hover:text-rose-400 font-medium transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> <span>Copy</span>
                            </button>
                        </div>

                        <div class="flex-grow bg-black border border-zinc-800 rounded-lg p-4 relative group min-h-[150px] flex flex-col overflow-hidden">
                            
                            <!-- Empty State -->
                            <div id="result-empty" class="h-full flex flex-col items-center justify-center text-zinc-700">
                                <i data-lucide="refresh-cw" class="mb-2 opacity-20 w-8 h-8"></i>
                                <span class="text-xs">Waiting for processing...</span>
                            </div>

                            <!-- Text Result (Encrypt Mode) -->
                            <div id="result-text" class="hidden break-all font-mono text-sm text-emerald-400"></div>

                            <!-- Launch Button (Decrypt Mode) -->
                            <div id="result-launch" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-[1px] pt-4 pb-2">
                                <div class="flex items-center gap-2 text-green-500 mb-3 flex-shrink-0">
                                    <i data-lucide="eye-off" class="w-4 h-4"></i>
                                    <span class="text-xs font-bold uppercase tracking-widest">Payload Verified & Masked</span>
                                </div>
                                
                                <!-- Dynamic Buttons Container -->
                                <div id="launch-buttons-container" class="flex flex-col gap-2 w-full px-4 overflow-y-auto btn-scroll items-center mb-2" style="max-height: 200px;">
                                    <!-- Buttons will be injected here via JS -->
                                </div>

                                <!-- Illusionary Link Display -->
                                <div id="illusion-link" class="mt-auto break-all font-mono text-xs text-zinc-600 blur-[1px] select-none text-center px-4 w-full"></div>
                            </div>

                        </div>

                        <div id="mode-hint" class="mt-4 text-xs text-zinc-600 text-center">
                            This string can only be decrypted by the Link Postmortem tool.
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-black border-t border-zinc-900 py-12 mt-auto">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between gap-8 mb-12">
                <div class="max-w-sm">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="skull" class="text-rose-600 w-6 h-6"></i>
                        <span class="text-lg font-bold text-white">Link Postmortem</span>
                    </div>
                    <p class="text-zinc-500 text-sm">
                        Advanced link forensics and extraction tools. Deconstruct the web, one link at a time.
                    </p>
                </div>
                <div>
                    <h4 class="text-white font-semibold mb-4 text-sm uppercase tracking-wider">Tools</h4>
                    <ul class="space-y-2 text-sm text-zinc-500">
                        <li class="hover:text-rose-500 cursor-pointer">Cloud Extractor</li>
                        <li class="hover:text-rose-500 cursor-pointer">Link Obfuscator</li>
                        <li class="hover:text-rose-500 cursor-pointer">Payload Analyzer</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-zinc-900 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-zinc-600">
                <p>Â© 2025 Link Postmortem. All rights reserved.</p>
                <div class="flex gap-4">
                    <span class="hover:text-white cursor-pointer">Privacy Protocol</span>
                    <span class="hover:text-white cursor-pointer">Terms of Execution</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. INITIALIZATION ---
        lucide.createIcons();

        // --- 2. TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            const btnDownloader = document.getElementById('btn-nav-downloader');
            const btnCrypter = document.getElementById('btn-nav-crypter');
            
            if(tabName === 'downloader') {
                btnDownloader.className = "px-6 py-1.5 rounded-full text-sm font-medium transition-all bg-zinc-800 text-white shadow-lg";
                btnCrypter.className = "px-6 py-1.5 rounded-full text-sm font-medium transition-all text-zinc-500 hover:text-zinc-300";
            } else {
                btnCrypter.className = "px-6 py-1.5 rounded-full text-sm font-medium transition-all bg-zinc-800 text-white shadow-lg";
                btnDownloader.className = "px-6 py-1.5 rounded-full text-sm font-medium transition-all text-zinc-500 hover:text-zinc-300";
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function clearInput(id) {
            document.getElementById(id).value = '';
            document.getElementById(id).focus();
        }

        async function pasteToInput(id) {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById(id).value = text;
            } catch (err) {
                console.error('Failed to read clipboard', err);
            }
        }

        // --- 3. DOWNLOADER LOGIC ---
        function handleDownload(e) {
            e.preventDefault();
            const urlInput = document.getElementById('dl-input').value.trim();
            const errorDiv = document.getElementById('dl-error');
            const resultDiv = document.getElementById('dl-result');
            const mediaResultDiv = document.getElementById('media-result');
            const btn = document.getElementById('dl-btn');
            const btnSpan = btn.querySelector('span');
            
            errorDiv.classList.add('hidden');
            resultDiv.classList.add('hidden');
            if(mediaResultDiv) mediaResultDiv.classList.add('hidden');

            const isCloud = urlInput.includes('terabox') || urlInput.includes('1024') || urlInput.includes('box');
            const isMedia = /\.(mp4|m3u8|mkv|avi|mov|webm|flv)(\?|$)/i.test(urlInput);
            
            if (!isCloud && !isMedia) {
                document.getElementById('dl-error-text').innerText = "Please enter a valid supported Cloud URL or a direct media link (mp4, m3u8).";
                errorDiv.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btnSpan.innerText = "Analyzing...";

            setTimeout(() => {
                if (isMedia) {
                    document.getElementById('media-download-btn').href = urlInput;
                    document.getElementById('media-url-display').innerText = urlInput;
                    const isStream = urlInput.includes('.m3u8');
                    const btnLabel = document.getElementById('media-btn-label');
                    if(btnLabel) btnLabel.innerText = isStream ? "Open Stream" : "Download File";
                    if(mediaResultDiv) mediaResultDiv.classList.remove('hidden');
                } else {
                    const encodedUrl = encodeURIComponent(urlInput);
                    const finalLink = `https://teradownloader.com/download?l=${encodedUrl}`;
                    document.getElementById('dl-iframe').src = finalLink;
                    document.getElementById('dl-external-link').href = finalLink;
                    resultDiv.classList.remove('hidden');
                }
                btn.disabled = false;
                btnSpan.innerText = "Extract";
            }, 800);
        }

        // --- 4. CRYPTO LOGIC ---
        const SALT = "POSTMORTEM_KEY_X9";
        const DELIMITER = "|||"; 
        const PASS_MARKER = "LOCKED::";
        const TIME_MARKER = "_TIME_";
        let currentMode = 'encrypt';
        let hiddenTargetUrls = []; 

        function complexEncrypt(text) {
            if (!text) return '';
            try {
                let result = btoa(text);
                let shifted = '';
                for (let i = 0; i < result.length; i++) {
                    shifted += String.fromCharCode(result.charCodeAt(i) + 5);
                }
                const salted = shifted.split('').reverse().join('') + `_SALT_${btoa(SALT)}`;
                return btoa(salted);
            } catch (e) {
                return "Error: Invalid input";
            }
        }

        function complexDecrypt(text) {
            if (!text) return null;
            try {
                let salted = atob(text);
                const saltMarker = `_SALT_${btoa(SALT)}`;
                if (!salted.includes(saltMarker)) return null;
                
                let rawShifted = salted.replace(saltMarker, '');
                let unreversed = rawShifted.split('').reverse().join('');
                let unshifted = '';
                for (let i = 0; i < unreversed.length; i++) {
                    unshifted += String.fromCharCode(unreversed.charCodeAt(i) - 5);
                }
                return atob(unshifted);
            } catch (e) {
                return null;
            }
        }

        // Password obfuscation helper
        function wrapWithPass(payload, pass) {
            let signature = btoa(pass).substring(0, 8);
            return PASS_MARKER + signature + "::" + complexEncrypt(payload); 
        }

        function unwrapPass(payload, pass) {
            if (!payload.startsWith(PASS_MARKER)) return null;
            const parts = payload.split('::');
            if (parts.length < 3) return null;
            const signature = parts[1];
            const content = parts[2];
            const attemptSignature = btoa(pass).substring(0, 8);
            if (signature !== attemptSignature) return "WRONG_PASS";
            return complexDecrypt(content);
        }

        function setCryptoMode(mode) {
            currentMode = mode;
            const btnEncrypt = document.getElementById('mode-encrypt');
            const btnDecrypt = document.getElementById('mode-decrypt');
            const input = document.getElementById('crypto-input');
            const actionBtn = document.getElementById('crypto-action-btn');
            const actionText = document.getElementById('action-text');
            const hint = document.getElementById('mode-hint');
            const settingsPanel = document.getElementById('crypto-settings');

            hiddenTargetUrls = [];
            resetCryptoResultUI();

            if (mode === 'encrypt') {
                btnEncrypt.className = "p-1.5 rounded-md transition-all bg-zinc-700 text-white";
                btnDecrypt.className = "p-1.5 rounded-md transition-all text-zinc-600 hover:text-zinc-400";
                input.placeholder = "Paste link(s) here. For multiple links, put each on a new line...";
                actionText.innerText = "Encrypt Payload";
                hint.innerText = "This string can only be decrypted by the Link Postmortem tool.";
                // Show settings in encrypt mode
                settingsPanel.classList.remove('hidden');
                settingsPanel.classList.add('grid');
            } else {
                btnDecrypt.className = "p-1.5 rounded-md transition-all bg-zinc-700 text-white";
                btnEncrypt.className = "p-1.5 rounded-md transition-all text-zinc-600 hover:text-zinc-400";
                input.placeholder = "Paste encrypted string...";
                actionText.innerText = "Decrypt & Verify";
                hint.innerText = "Decryption attempts to reconstruct the original link source.";
                // Hide extra settings in decrypt mode (passcode input handled dynamically if needed, but simple UI hides it)
                // Actually, keep passcode visible for input
                settingsPanel.classList.remove('grid');
                settingsPanel.classList.add('hidden');
                // We show a simplified pass field only if needed, but for now lets keep the passcode field visible 
                // actually better to hide lifespan in decrypt mode.
                
                // Let's modify the UI logic slightly: Hide the settings panel entirely in decrypt mode?
                // No, we need passcode input for decryption. 
                // Let's hide the Expiry select but keep Passcode input.
                settingsPanel.classList.remove('hidden');
                settingsPanel.classList.add('grid');
                document.getElementById('crypto-expiry').parentElement.style.display = 'none';
                document.getElementById('crypto-pass').placeholder = "Enter passcode if required";
            }
            
            if(mode === 'encrypt') {
                 document.getElementById('crypto-expiry').parentElement.style.display = 'block';
                 document.getElementById('crypto-pass').placeholder = "Leave empty for open access";
            }
        }

        function resetCryptoResultUI() {
            document.getElementById('result-empty').classList.remove('hidden');
            document.getElementById('result-text').classList.add('hidden');
            document.getElementById('result-text').innerText = "";
            document.getElementById('result-launch').classList.add('hidden');
            document.getElementById('btn-copy').classList.add('hidden');
            document.getElementById('launch-buttons-container').innerHTML = ''; 
        }

        function handleCryptoProcess() {
            const inputVal = document.getElementById('crypto-input').value.trim();
            const passVal = document.getElementById('crypto-pass').value.trim();
            const expiryVal = parseInt(document.getElementById('crypto-expiry').value);
            
            if(!inputVal) return;

            resetCryptoResultUI();
            
            if (currentMode === 'encrypt') {
                // 1. Prepare Content
                const lines = inputVal.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length === 0) return;
                let payload = lines.join(DELIMITER);
                
                // 1.5 Handle Expiration
                if(expiryVal > 0) {
                    const expiryTime = Date.now() + (expiryVal * 60 * 1000); // minutes to ms
                    payload += TIME_MARKER + expiryTime;
                }

                // 2. Encrypt Content (Standard)
                let finalOutput = complexEncrypt(payload);

                // 3. Apply Password Wrapping if needed
                if(passVal) {
                    finalOutput = wrapWithPass(payload, passVal); 
                }

                document.getElementById('result-empty').classList.add('hidden');
                const resText = document.getElementById('result-text');
                resText.innerText = finalOutput;
                resText.classList.remove('hidden');
                document.getElementById('btn-copy').classList.remove('hidden');
            } else {
                // DECRYPT MODE
                let decrypted = null;
                document.getElementById('result-empty').classList.add('hidden');

                // Check if Locked
                if (inputVal.startsWith(PASS_MARKER)) {
                    if (!passVal) {
                        const resText = document.getElementById('result-text');
                        resText.innerText = "Error: This payload is locked. Please enter the passcode.";
                        resText.classList.remove('hidden');
                        resText.classList.add('text-red-500');
                        return;
                    }
                    const unlockResult = unwrapPass(inputVal, passVal);
                    if (unlockResult === "WRONG_PASS") {
                        const resText = document.getElementById('result-text');
                        resText.innerText = "Error: Invalid Passcode.";
                        resText.classList.remove('hidden');
                        resText.classList.add('text-red-500');
                        return;
                    }
                    decrypted = unlockResult;
                } else {
                    // Standard Decrypt
                    decrypted = complexDecrypt(inputVal);
                }
                
                if (decrypted) {
                    // Check Expiration
                    if(decrypted.includes(TIME_MARKER)) {
                        const parts = decrypted.split(TIME_MARKER);
                        const content = parts[0];
                        const expiry = parseInt(parts[1]);
                        
                        if(Date.now() > expiry) {
                            const resText = document.getElementById('result-text');
                            resText.innerHTML = "STATUS: <b>DECEASED</b><br>This link has expired and the payload has been purged.";
                            resText.classList.remove('hidden');
                            resText.classList.add('text-red-500');
                            return;
                        }
                        decrypted = content; // Continue with valid content
                    }

                    hiddenTargetUrls = decrypted.split(DELIMITER);
                    const container = document.getElementById('launch-buttons-container');
                    
                    hiddenTargetUrls.forEach((url, index) => {
                        const btn = document.createElement('button');
                        btn.className = "bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-full flex items-center gap-2 transition-all shadow-[0_0_15px_rgba(16,185,129,0.4)] w-full justify-center";
                        btn.innerHTML = `Launch Target ${hiddenTargetUrls.length > 1 ? index + 1 : ''} <i data-lucide="arrow-right-circle" class="w-4 h-4"></i>`;
                        btn.onclick = () => window.open(url, '_blank', 'noopener,noreferrer');
                        container.appendChild(btn);
                    });
                    
                    lucide.createIcons();

                    const fakeId = Math.random().toString(36).substring(2, 10).toUpperCase();
                    const illusionUrl = `https://postmortem.secure/redirect?auth=${fakeId}&status=verified&batch=${hiddenTargetUrls.length}`;
                    document.getElementById('illusion-link').innerText = illusionUrl;
                    
                    document.getElementById('result-launch').classList.remove('hidden');
                } else {
                    const resText = document.getElementById('result-text');
                    resText.innerText = "Error: Decryption failed. Invalid signature or corrupted string.";
                    resText.classList.remove('hidden');
                    resText.classList.add('text-red-500');
                }
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('result-text').innerText;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const btn = document.getElementById('btn-copy').querySelector('span');
                    const originalText = btn.innerText;
                    btn.innerText = "Copied";
                    setTimeout(() => btn.innerText = originalText, 2000);
                }
            } catch (err) {
                console.error('Unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        function launchTarget() {
            if (hiddenTargetUrls.length > 0) {
                window.open(hiddenTargetUrls[0], '_blank', 'noopener,noreferrer');
            }
        }
    </script>
</body>
</html>
